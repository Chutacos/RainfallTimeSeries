---
title: "ADS506 Project Australia Rainfall Forecast"
author: "Marinela Inguito, Jose Guarneros, Robert Marriott"

output: pdf_document
---

```{r warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyr)
library(tsibble)
library(tseries)
library(feasts)
library(fpp3)
```

## Importing the Data

```{r}
weather_data <- read.csv("weatherAUS.csv")
str(weather_data$Date)
```

## Preview of Data

```{r}
str(weather_data)      # Structure of the dataset
summary(weather_data)  # Summary statistics for each column
head(weather_data)     
```

## Data Preprocessing
## Convert Date Column

```{r}
weather_data$Date <- as.Date(weather_data$Date, format = "%Y-%m-%d")
str(weather_data$Date)
```
## Arrange the date

```{r}
weather_data <- weather_data %>%
  arrange(Date)
```

## Relevant Columns Filtered

```{r}
weather_data <- weather_data |>
  select(Date, Location, Rainfall, MinTemp, MaxTemp, RainTomorrow)
```

## Specific Cities Filtered

```{r}
cities <- c("Sydney", "Perth", "Darwin", "Melbourne")
weather_data <- weather_data |> filter(Location %in% cities)
```

## Data Cleaning
## Handle Missing Values

```{r}
colSums(is.na(weather_data))
```

## Drop rows with missing Values from Rainfall or RainTomorrow

```{r}
weather_data <- weather_data |> drop_na(Rainfall, RainTomorrow)
```

## Impute other columns using the mean

```{r}
weather_data$MinTemp[is.na(weather_data$MinTemp)] <- mean(weather_data$MinTemp, na.rm = TRUE)
weather_data$MaxTemp[is.na(weather_data$MaxTemp)] <- mean(weather_data$MaxTemp, na.rm = TRUE)
```

## Verify Data Types

```{r}
str(weather_data)  # Confirm all variables have correct data types
colnames(weather_data)
```

## Aggregate Weekly Rainfall

```{r}
weather_data_weekly <- weather_data |>
  mutate(Week = floor_date(Date, "week")) |>
  group_by(Location, Week) |>
  summarize(WeeklyRainfall = sum(Rainfall, na.rm = TRUE)) |>
  ungroup()
```

## Differencing for stationarity

```{r}
weather_data <- weather_data |>
  group_by(Location) |>
  mutate(Diff_Rainfall = c(NA, diff(Rainfall))) |>
  ungroup()
```

## Remove rows with N/A

```{r}
weather_data <- weather_data |>
  drop_na()

head(weather_data)
```
## Time Series Plot

```{r}
# Filter data for a specific location (e.g., Sydney)
sydney_weather <- weather_data %>%
  filter(Location == "Sydney") %>%
  select(Date, Rainfall) %>%
  drop_na(Rainfall)

# Convert to tsibble
sydney_weather_tsibble <- sydney_weather %>%
  mutate(Date = yearmonth(Date)) %>%
  as_tsibble(index = Date)

# Plot the time series using autoplot
sydney_weather_tsibble %>%
  autoplot(Rainfall) +
  labs(title = "Rainfall Time Series for Sydney",
       x = "Time",
       y = "Rainfall (mm)") +
  theme_minimal()

```




## Update the code below after fixing time series plot


## Split data by city

```{r}
weather_data_splits <- split(weather_data, weather_data$Location)
```

## Perform decomposition of each city next

```{r}
sydney_data <- weather_data_splits$Sydney
sydney_ts <- sydney_data %>%
  as_tsibble(index = Date) %>%
  fill_gaps()
```

# Perform Decomposition Sydney

```{r}
sydney_decomposition <- sydney_ts %>%
  model(STL(Rainfall ~ season(window = 13))) %>%
  components()
```

# Plot Decomposition

```{r}
autoplot(sydney_decomposition) +
  labs(title = "STL Decomposition of Rainfall in Sydney", y = "")
```

# acf plot Sydney

```{r}
acf_plot_Sydney <- sydney_ts %>%
  ACF(Rainfall) %>%
  autoplot() +
  labs(title = "ACF of Rainfall in Sydney", y = "ACF", x = "Lag") +
  theme_minimal()

acf_plot_Sydney
```




## Splitting Data?

```{r}
max(weather_data$Date)
min(weather_data$Date)

train <- weather_data |>
  filter(Date >= as.Date("2008-02-03") & Date <= as.Date("2015-06-24") )

test <- weather_data |>
  filter(Date >= as.Date("2015-06-25") & Date <= as.Date("2017-06-25"))

```


```{r}
weekly_rainfall <- train |>
  mutate(Week = floor_date(Date, "week")) |>
  group_by(Week) |>                          
  summarize(WeeklyRainfall = sum(Rainfall, na.rm = TRUE))

weekly_rainfall_test <- test |>
  mutate(Week = floor_date(Date, "week")) |>
  group_by(Week) |>                          
  summarize(WeeklyRainfall = sum(Rainfall, na.rm = TRUE))

weekly_rainfall |>
  ggplot(aes(x = Week, y = WeeklyRainfall)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Railfall over time", x = "Date", y = "Rainfall")

weekly_rainfall_test |>
  ggplot(aes(x = Week, y = WeeklyRainfall)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Railfall over time (Test set)", x = "Date", y = "Rainfall")

```

## Exploratory Data Analysis?

```{r}
train <- train |>
  group_by(Date) |>
  summarize(Rainfall = sum(Rainfall, na.rm = TRUE)) |>  # Aggregate rainfall
  ungroup()

train <- train |>
  distinct(Date, .keep_all = TRUE)

train <- train |>
  mutate(Diff_Rainfall = difference(Rainfall)) |>
  filter(!is.na(Diff_Rainfall)) |>
  as_tsibble(index = Date) |>
  fill_gaps()

acf_plot <- train |>
  ACF(Diff_Rainfall) |>
  autoplot() +
  labs(title = "ACF of Differenced Weekly Rainfall", y = "ACF", x = "Lag") +
  theme_minimal()

acf_plot
```



